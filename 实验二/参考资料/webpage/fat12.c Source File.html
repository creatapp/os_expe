<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0058)http://minirighi.sourceforge.net/html/fat12_8c-source.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<title>fat12.c Source File</title>
<link href="./fat12.c Source File_files/doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="http://minirighi.sourceforge.net/html/index.html">Main Page</a> &nbsp; <a class="qindex" href="http://minirighi.sourceforge.net/html/modules.html">Modules</a> &nbsp; <a class="qindex" href="http://minirighi.sourceforge.net/html/classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="http://minirighi.sourceforge.net/html/annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="http://minirighi.sourceforge.net/html/files.html">File List</a> &nbsp; <a class="qindex" href="http://minirighi.sourceforge.net/html/functions.html">Data Fields</a> &nbsp; <a class="qindex" href="http://minirighi.sourceforge.net/html/globals.html">Globals</a> &nbsp; <a class="qindex" href="http://minirighi.sourceforge.net/html/pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>fat12.c</h1><a href="http://minirighi.sourceforge.net/html/fat12_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*!     \file fs/fat12/fat12.c</span>
00002 <span class="comment"> *      \brief FAT-12 fyle system.</span>
00003 <span class="comment"> *      \author</span>
00004 <span class="comment"> *              Matteo Chesi &lt;dalamar@inwind.it&gt;</span>
00005 <span class="comment"> *              Rudy Manganelli &lt;feller@libero.it&gt;</span>
00006 <span class="comment"> *              Andrea Righi &lt;drizzt@inwind.it&gt;</span>
00007 <span class="comment"> *      \date Last update: 2003-11-09</span>
00008 <span class="comment"> *      \note Copyright (&amp;copy;) 2003</span>
00009 <span class="comment"> *              Matteo Chesi &lt;dalamar@inwind.it&gt;</span>
00010 <span class="comment"> *              Rudy Manganelli &lt;feller@libero.it&gt;</span>
00011 <span class="comment"> *              Andrea Righi &lt;drizzt@inwind.it&gt;</span>
00012 <span class="comment"> */</span>
00013 
00014 <span class="preprocessor">#include &lt;<a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html">const.h</a>&gt;</span>
00015 <span class="preprocessor">#include &lt;<a class="code" href="http://minirighi.sourceforge.net/html/string_8h.html">string.h</a>&gt;</span>
00016 
00017 <span class="preprocessor">#include &lt;<a class="code" href="http://minirighi.sourceforge.net/html/mem_8h.html">arch/mem.h</a>&gt;</span>
00018 
00019 <span class="preprocessor">#include &lt;<a class="code" href="http://minirighi.sourceforge.net/html/console_8h.html">kernel/console.h</a>&gt;</span>
00020 <span class="preprocessor">#include &lt;<a class="code" href="http://minirighi.sourceforge.net/html/floppy_8h.html">kernel/floppy.h</a>&gt;</span>
00021 <span class="preprocessor">#include &lt;<a class="code" href="http://minirighi.sourceforge.net/html/keyboard_8h.html">kernel/keyboard.h</a>&gt;</span>
00022 <span class="preprocessor">#include &lt;<a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8h.html">kernel/kmalloc.h</a>&gt;</span>
00023 
00024 <span class="preprocessor">#include &lt;<a class="code" href="http://minirighi.sourceforge.net/html/fat_8h.html">kernel/fat.h</a>&gt;</span>
00025 
00026 <span class="comment">// FAT global variables //</span>
<a name="l00027"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a0">00027</a> <a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html">bootsect_t</a> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a0">bootsector</a>;
<a name="l00028"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a1">00028</a> <a class="code" href="http://minirighi.sourceforge.net/html/structFAT12.html">FAT12_t</a> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a1">fat</a>;
<a name="l00029"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a2">00029</a> <a class="code" href="http://minirighi.sourceforge.net/html/structlogical__FAT12.html">logical_FAT12_t</a> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a2">lfat</a>;
<a name="l00030"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">00030</a> <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>=0;
<a name="l00031"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a4">00031</a> <span class="keywordtype">char</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a4">path</a>[256];
00032 
00033 <span class="comment">// ---------- File system procedures ---------- //</span>
<a name="l00034"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a5">00034</a> <span class="keywordtype">bool</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a5">next_sector</a>(<a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> *next, <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> actual)
00035 {
00036         *next = lfat.<a class="code" href="http://minirighi.sourceforge.net/html/structlogical__FAT12.html#m0">data</a>[actual];
00037         <span class="keywordflow">if</span> ( (*next == 0) || (*next &gt;= 0x0FF0) )
00038                 <span class="keywordflow">return</span>(FALSE);
00039         <span class="keywordflow">else</span>
00040                 <span class="keywordflow">return</span>(TRUE);
00041 }
00042 
<a name="l00043"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a6">00043</a> <span class="keywordtype">int</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a6">how_many_cluster</a>(<a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> start)
00044 {
00045         <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> c=1, cl;
00046 
00047         <span class="comment">// The root directory (start=0) has a fixed size                        //</span>
00048         <span class="keywordflow">if</span> (!start)
00049                 <span class="keywordflow">return</span>( (bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m6">RootDirectoryEntries</a>*<span class="keyword">sizeof</span>(FileEntry_t))/bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m2">BytesPerSector</a> );
00050 
00051         <span class="comment">// Calculate the size of the directory (it's not the root!)             //</span>
00052         cl=start;
00053 
00054         <span class="keywordflow">while</span> (<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a5">next_sector</a>(&amp;cl, cl)) c++;
00055         <span class="keywordflow">return</span>(c);
00056 }
00057 
<a name="l00058"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a7">00058</a> <span class="keywordtype">void</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a7">int_to_date</a>(<a class="code" href="http://minirighi.sourceforge.net/html/structdate.html">date_t</a> *d, <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> <a class="code" href="http://minirighi.sourceforge.net/html/structdate.html">date</a>)
00059 {
00060         d-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structdate.html#m0">year</a>=<a class="code" href="http://minirighi.sourceforge.net/html/structdate.html">date</a>/512;
00061         d-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structdate.html#m1">month</a>=(<a class="code" href="http://minirighi.sourceforge.net/html/structdate.html">date</a>-(d-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structdate.html#m0">year</a>*512))/32;
00062         d-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structdate.html#m2">day</a>=<a class="code" href="http://minirighi.sourceforge.net/html/structdate.html">date</a>-(d-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structdate.html#m0">year</a>*512)-(d-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structdate.html#m1">month</a>*32);
00063 }
00064 
<a name="l00065"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a8">00065</a> <span class="keywordtype">void</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a8">int_to_time</a>(<a class="code" href="http://minirighi.sourceforge.net/html/structfat__time.html">fat_time_t</a> *time, <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> t)
00066 {
00067         time-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structfat__time.html#m0">hour</a>=t/2048;
00068         time-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structfat__time.html#m1">minute</a>=(t-(time-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structfat__time.html#m0">hour</a>*2048))/32;
00069         time-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structfat__time.html#m2">second</a>=(t-(time-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structfat__time.html#m0">hour</a>*2048)-(time-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structfat__time.html#m1">minute</a>*32))*2;
00070 }
00071 
<a name="l00072"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a9">00072</a> <span class="keywordtype">void</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a9">read_attrib</a>(<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html">attrib_t</a> *FileAttr, <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a0">byte</a> <a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html">attrib</a>)
00073 {
00074         FileAttr-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m0">RW</a>=       (<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html">attrib</a> &amp; (byte)0x1) &amp;&amp; 0x1;
00075         FileAttr-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m1">Hidden</a>=   (<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html">attrib</a> &amp; (byte)0x2) &amp;&amp; 0x2;
00076         FileAttr-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m2">System</a>=   (<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html">attrib</a> &amp; (byte)0x4) &amp;&amp; 0x4;
00077         FileAttr-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m3">Label</a>=    (<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html">attrib</a> &amp; (byte)0x8) &amp;&amp; 0x8;
00078         FileAttr-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m4">Directory</a>=(<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html">attrib</a> &amp; (byte)0x10)&amp;&amp; 0x10;
00079         FileAttr-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m5">Archived</a>= (<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html">attrib</a> &amp; (byte)0x20)&amp;&amp; 0x20;
00080         FileAttr-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m6">Reserved</a>= <a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html">attrib</a>&gt;&gt;6;
00081 }
00082 
<a name="l00083"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a10">00083</a> <span class="keywordtype">char</span> *<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a10">show_attrib</a>(<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html">attrib_t</a> *FileAttr, <span class="keywordtype">char</span> *stringa)
00084 {
00085         <span class="keywordflow">if</span> (FileAttr-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m3">Label</a>)
00086         {
00087                 stringa=<span class="stringliteral">"LABEL   "</span>;
00088                 <span class="keywordflow">return</span> stringa;
00089         }
00090         <span class="keywordflow">if</span> (FileAttr-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m4">Directory</a>)
00091         {
00092                 stringa=<span class="stringliteral">"DIR     "</span>;
00093                 <span class="keywordflow">return</span> stringa;
00094         }
00095         stringa[0]=<span class="charliteral">'r'</span>;
00096         <span class="keywordflow">if</span> (FileAttr-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m0">RW</a>) stringa[1]=<span class="charliteral">'-'</span>; <span class="comment">//ReadOnly</span>
00097         <span class="keywordflow">else</span> stringa[1]=<span class="charliteral">'+'</span>;<span class="comment">//Read and Write</span>
00098         stringa[2]=<span class="charliteral">'h'</span>;
00099         <span class="keywordflow">if</span> (FileAttr-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m1">Hidden</a>) stringa[3]=<span class="charliteral">'+'</span>; <span class="comment">//Hidden</span>
00100         <span class="keywordflow">else</span> stringa[3]=<span class="charliteral">'-'</span>;<span class="comment">//Visible</span>
00101         stringa[4]=<span class="charliteral">'s'</span>;
00102         <span class="keywordflow">if</span> (FileAttr-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m2">System</a>) stringa[5]=<span class="charliteral">'+'</span>; <span class="comment">//System</span>
00103         <span class="keywordflow">else</span> stringa[5]=<span class="charliteral">'-'</span>;<span class="comment">//NonSystem</span>
00104         stringa[6]=<span class="charliteral">'a'</span>;
00105         <span class="keywordflow">if</span> (FileAttr-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m5">Archived</a>) stringa[7]=<span class="charliteral">'+'</span>; <span class="comment">//Archived</span>
00106         <span class="keywordflow">else</span> stringa[7]=<span class="charliteral">'-'</span>;<span class="comment">//NotArchived</span>
00107         stringa[8]=<span class="charliteral">'\0'</span>;
00108 
00109         <span class="keywordflow">return</span> stringa;
00110 }
00111 
<a name="l00112"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a11">00112</a> <span class="keywordtype">char</span> *<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a11">file_name</a>(<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html">FileEntry_t</a> *temp, <span class="keywordtype">char</span> *stringa)
00113 {
00114         <span class="keywordtype">int</span> k, a;
00115 
00116         a=0;
00117         <span class="keywordflow">for</span>(k=0; k&lt;8; k++)
00118         {
00119                 <span class="keywordflow">if</span> ((temp-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m0">Name</a>[k]!=0)&amp;&amp;(temp-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m0">Name</a>[k]!=<span class="charliteral">' '</span>))
00120                 {
00121                         stringa[k]=temp-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m0">Name</a>[k];
00122                         a=k;
00123                 }
00124         }
00125         <span class="keywordflow">for</span>(k=0;k&lt;3;k++)
00126         {
00127                 <span class="keywordflow">if</span> (temp-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m1">Extension</a>[k]!=<span class="charliteral">' '</span>)
00128                 {
00129                         <span class="keywordflow">if</span> (k==0) stringa[++a]=<span class="charliteral">'.'</span>;
00130                         stringa[++a]=temp-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m1">Extension</a>[k];
00131                 }
00132         }
00133         <span class="keywordflow">for</span>(a++;a&lt;12;a++) stringa[a]=<span class="charliteral">' '</span>;
00134         stringa[12]=<span class="charliteral">'\0'</span>;
00135 
00136         <span class="keywordflow">return</span> stringa;
00137 }
00138 
<a name="l00139"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a12">00139</a> <span class="keywordtype">bool</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a12">show_file_entry</a>(<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html">FileEntry_t</a> *TempFile)
00140 {
00141         <a class="code" href="http://minirighi.sourceforge.net/html/structdate.html">date_t</a> FileDate;
00142         <a class="code" href="http://minirighi.sourceforge.net/html/structfat__time.html">fat_time_t</a> FileTime;
00143         <a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html">attrib_t</a> FileAttr;
00144         <span class="keywordtype">char</span> Attributi[8];
00145         <span class="keywordtype">char</span> Nome[13];
00146 
00147         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a9">read_attrib</a>(&amp;FileAttr, TempFile-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m2">Attribute</a>);
00148         <span class="keywordflow">if</span> (!FileAttr.<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m3">Label</a>)
00149         {
00150                 <span class="keywordflow">if</span> ( (TempFile-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m0">Name</a>[0]) &amp;&amp; (TempFile-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m0">Name</a>[0]!=0xE5) )
00151                 {
00152                         <span class="keywordflow">if</span> (TempFile-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m0">Name</a>[0]==0x05) TempFile-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m0">Name</a>[0]=0xE5;
00153                         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a7">int_to_date</a>(&amp;FileDate, TempFile-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m5">Date</a>);
00154                         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a8">int_to_time</a>(&amp;FileTime, TempFile-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m4">Time</a>);
00155 
00156                         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"%s"</span>, <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a11">file_name</a>(TempFile, Nome));
00157                         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a12">gotoxy</a>(15, -1);
00158                         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"%s"</span>, <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a10">show_attrib</a>(&amp;FileAttr, Attributi));
00159                         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a12">gotoxy</a>(25, -1);
00160                         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"%d/%d/%u"</span>, FileDate.<a class="code" href="http://minirighi.sourceforge.net/html/structdate.html#m2">day</a>, FileDate.<a class="code" href="http://minirighi.sourceforge.net/html/structdate.html#m1">month</a>, (FileDate.<a class="code" href="http://minirighi.sourceforge.net/html/structdate.html#m0">year</a>+1980));
00161                         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a12">gotoxy</a>(36, -1);
00162                         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"%d:%d:%d"</span>, FileTime.<a class="code" href="http://minirighi.sourceforge.net/html/structfat__time.html#m0">hour</a>, FileTime.<a class="code" href="http://minirighi.sourceforge.net/html/structfat__time.html#m1">minute</a>, FileTime.<a class="code" href="http://minirighi.sourceforge.net/html/structfat__time.html#m2">second</a>);
00163                         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a12">gotoxy</a>(46, -1);
00164                         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"S:%#x"</span>, TempFile-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m6">StartCluster</a>);
00165                         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a12">gotoxy</a>(60, -1);
00166                         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"D:%u"</span>, TempFile-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m7">FileLength</a>);
00167                         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"\n\r"</span>);
00168 
00169                         <span class="keywordflow">if</span> (TempFile-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m0">Name</a>[0]==0xE5) TempFile-&gt;<a class="code" href="http://minirighi.sourceforge.net/html/structFileEntry.html#m0">Name</a>[0]=0x05;
00170 
00171                         <span class="keywordflow">return</span> <a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a0">TRUE</a>;
00172                 }
00173         }
00174         <span class="keywordflow">return</span> <a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a1">FALSE</a>;
00175 }
00176 
<a name="l00177"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a13">00177</a> <span class="keywordtype">void</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a13">name_ext</a>(<span class="keywordtype">char</span> *filename, <span class="keywordtype">char</span> *<a class="code" href="http://minirighi.sourceforge.net/html/ext2_8c.html#a28">name</a>, <span class="keywordtype">char</span> *ext)
00178 {
00179         <span class="keywordtype">int</span> <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>;
00180         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *find;
00181 
00182         <span class="comment">// Set the string to uppercase                                  //</span>
00183         <a class="code" href="http://minirighi.sourceforge.net/html/group__LibCString.html#a9">strtoupper</a>(filename);
00184 
00185         <span class="comment">// Get the file name                                            //</span>
00186         <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;8; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00187         {
00188                 <span class="keywordflow">if</span> ( (filename[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>]==<span class="charliteral">'.'</span>) || (filename[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>]==<span class="charliteral">'\0'</span>) )
00189                         <span class="keywordflow">break</span>;
00190                 <a class="code" href="http://minirighi.sourceforge.net/html/ext2_8c.html#a28">name</a>[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>] = filename[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>];
00191         }
00192         <span class="keywordflow">for</span>(; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;8; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00193                 <a class="code" href="http://minirighi.sourceforge.net/html/ext2_8c.html#a28">name</a>[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>] = <span class="charliteral">' '</span>;
00194         <a class="code" href="http://minirighi.sourceforge.net/html/ext2_8c.html#a28">name</a>[8] = <span class="charliteral">'\0'</span>;
00195 
00196         <span class="comment">// Get the file extension                                       //</span>
00197         find = <a class="code" href="http://minirighi.sourceforge.net/html/group__LibCString.html#a8">strstr</a>(filename, <span class="stringliteral">"."</span>);
00198         <span class="keywordflow">if</span> (find++)
00199         {
00200                 <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;3; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00201                 {
00202                         <span class="keywordflow">if</span> (find[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>]==<span class="charliteral">'\0'</span>)
00203                                 <span class="keywordflow">break</span>;
00204                         ext[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>] = find[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>];
00205                 }
00206                 <span class="keywordflow">for</span>(; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;3; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00207                         ext[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>] = <span class="charliteral">' '</span>;
00208         }
00209         <span class="keywordflow">else</span>
00210         {
00211                 <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;3; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00212                         ext[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>] = <span class="charliteral">' '</span>;
00213         }
00214         ext[3] = <span class="charliteral">'\0'</span>;
00215 }
00216 
<a name="l00217"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a14">00217</a> <span class="keywordtype">bool</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a14">compare_name_ext</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *name1, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *name2, <span class="keywordtype">char</span> *ext1, <span class="keywordtype">char</span> *ext2)
00218 {
00219         <span class="keywordtype">bool</span> different = <a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a0">TRUE</a>;
00220         <span class="keywordflow">if</span> ( (*name1 != 0) &amp;&amp; (*name1 != 0xE5) )
00221         {
00222                 <span class="keywordflow">if</span> (*name1 == 0x05) *name1=0xE5;
00223 
00224                 <span class="keywordflow">if</span> ( (<a class="code" href="http://minirighi.sourceforge.net/html/group__LibCString.html#a5">strncmp</a>(name1, name2, 8) == 0) &amp;&amp; (<a class="code" href="http://minirighi.sourceforge.net/html/group__LibCString.html#a5">strncmp</a>(ext1, ext2, 3) == 0) )
00225                         different = <a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a1">FALSE</a>;
00226 
00227                 <span class="keywordflow">if</span> (*name1 == 0xE5) *name1=0x05;
00228         }
00229         <span class="keywordflow">return</span>(!different);
00230 }
00231 
00232 <span class="comment">// --- Read procedures -------------------------------------------------//</span>
<a name="l00233"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a15">00233</a> <span class="keywordtype">void</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a15">read_file</a>(<a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector_t</a> *Buf, <span class="keywordtype">int</span> start, <span class="keywordtype">int</span> c)
00234 {
00235         <span class="keywordtype">int</span> <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>, j;
00236         <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> a;
00237         <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> dir_start = bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m5">Fats</a>*bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m9">SectorsPerFat</a>+1;
00238         <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> data_start = dir_start + bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m6">RootDirectoryEntries</a>*32/bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m2">BytesPerSector</a>-2;
00239 
00240         <span class="keywordflow">if</span>(!start)
00241         {
00242                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)
00243                         <span class="keywordflow">if</span> (<a class="code" href="http://minirighi.sourceforge.net/html/floppy_8c.html#a21">fdc_read</a>(dir_start, (<a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a0">byte</a> *)Buf, c)) <span class="keywordflow">break</span>;
00244         }
00245         <span class="keywordflow">else</span>
00246         {
00247                 <span class="comment">// Read the start sector //</span>
00248                 a=start;
00249                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)
00250                         <span class="keywordflow">if</span> (<a class="code" href="http://minirighi.sourceforge.net/html/floppy_8c.html#a21">fdc_read</a>(data_start+a, (<a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a0">byte</a> *)Buf, 1)) <span class="keywordflow">break</span>;
00251 
00252                 <span class="comment">// Read the other sectors //</span>
00253                 <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=1; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;c; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00254                 {
00255                         <span class="keywordflow">if</span> (<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a5">next_sector</a>(&amp;a, a))
00256                         {
00257                                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)
00258                                         <span class="keywordflow">if</span> (<a class="code" href="http://minirighi.sourceforge.net/html/floppy_8c.html#a21">fdc_read</a>(data_start+a, (<a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a0">byte</a> *)(Buf+<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>), 1)) <span class="keywordflow">break</span>;
00259                         }
00260                         <span class="keywordflow">else</span>
00261                                 <span class="comment">// End of file //</span>
00262                                 <span class="keywordflow">break</span>;
00263                 }
00264         }
00265 }
00266 
<a name="l00267"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a16">00267</a> <span class="keywordtype">bool</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a16">load_file</a>(<span class="keywordtype">char</span> *stringa, <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a0">byte</a> *buffer)
00268 {
00269         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> Nome[9], Ext[4];
00270         <a class="code" href="http://minirighi.sourceforge.net/html/structSectorDir.html">SectorDir_t</a> *Buf;
00271         <span class="keywordtype">int</span> counter, count;
00272         <span class="keywordtype">int</span> h, <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>;
00273         <span class="keywordtype">bool</span> found=<a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a1">FALSE</a>;
00274 
00275         <span class="comment">// Get the file name and extension //</span>
00276         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a13">name_ext</a>(stringa, Nome, Ext);
00277 
00278         <span class="comment">// Get the list of file into the current directory //</span>
00279         counter = <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a6">how_many_cluster</a>(<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>);
00280 
00281         Buf = <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a1">kmalloc</a>(<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>*counter);
00282         <a class="code" href="http://minirighi.sourceforge.net/html/group__KLowLevelMemoryManager.html#a7">memset</a>(Buf, 0, <a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>*counter);
00283 
00284         <span class="comment">// Read the directory //</span>
00285         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a15">read_file</a>((<a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector_t</a> *)Buf, <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>, counter);
00286 
00287         <span class="keywordflow">for</span>(h=0; h&lt;counter; h++)
00288         {
00289                 <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>/<span class="keyword">sizeof</span>(FileEntry_t); <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00290                 {
00291                         found = <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a14">compare_name_ext</a>(Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Name, Nome, Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Extension, Ext);
00292                         <span class="keywordflow">if</span> (found)
00293                         {
00294                                 <span class="comment">// The file is empty //</span>
00295                                 <span class="keywordflow">if</span> ( !(Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].StartCluster) ) <span class="keywordflow">goto</span> founded;
00296 
00297                                 <span class="comment">// Copy the file into the buffer //</span>
00298                                 count = <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a6">how_many_cluster</a>(Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].StartCluster);
00299                                 <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a15">read_file</a>((<a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector_t</a> *)buffer, Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].StartCluster, count);
00300                                 <span class="keywordflow">goto</span> founded;
00301                         }
00302                 }
00303         }
00304 founded:
00305         <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a3">kfree</a>(Buf);
00306 
00307         <span class="keywordflow">if</span> (!found) <span class="keywordflow">return</span>(FALSE);
00308         <span class="keywordflow">return</span>(TRUE);
00309 }
00310 
<a name="l00311"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a17">00311</a> <span class="keywordtype">int</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a17">get_file_size</a>(<span class="keywordtype">char</span> *<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a11">file_name</a>)
00312 {
00313 <span class="comment">// Get the size of a file //</span>
00314         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="http://minirighi.sourceforge.net/html/ext2_8c.html#a28">name</a>[9], ext[4];
00315         <a class="code" href="http://minirighi.sourceforge.net/html/structSectorDir.html">SectorDir_t</a> *Buf;
00316         <span class="keywordtype">int</span> counter, count=0, h, <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>;
00317         <span class="keywordtype">bool</span> found=<a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a1">FALSE</a>;
00318 
00319         <span class="comment">// Get the file name and extension //</span>
00320         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a13">name_ext</a>(<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a11">file_name</a>, <a class="code" href="http://minirighi.sourceforge.net/html/ext2_8c.html#a28">name</a>, ext);
00321 
00322         <span class="comment">// Get the list of file into the current directory //</span>
00323         counter = <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a6">how_many_cluster</a>(<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>);
00324         Buf = <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a1">kmalloc</a>(<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>*counter);
00325         <a class="code" href="http://minirighi.sourceforge.net/html/group__KLowLevelMemoryManager.html#a7">memset</a>(Buf, 0, <a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>*counter);
00326         <span class="comment">// Read the directory //</span>
00327         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a15">read_file</a>((<a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector_t</a> *)Buf, <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>, counter);
00328 
00329         <span class="comment">// Find the file //</span>
00330         <span class="keywordflow">for</span>(h=0; h&lt;counter; h++)
00331         {
00332                 <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>/<span class="keyword">sizeof</span>(FileEntry_t); <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00333                 {
00334                         found = <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a14">compare_name_ext</a>(Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Name, <a class="code" href="http://minirighi.sourceforge.net/html/ext2_8c.html#a28">name</a>, Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Extension, ext);
00335                         <span class="keywordflow">if</span> (found)
00336                         {
00337                                 <span class="comment">// The file is empty //</span>
00338                                 <span class="keywordflow">if</span> ( !(Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].StartCluster) ) <span class="keywordflow">goto</span> founded;
00339 
00340                                 <span class="comment">// Get the size in clusters //</span>
00341                                 count = <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a6">how_many_cluster</a>(Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].StartCluster);
00342                                 <span class="keywordflow">goto</span> founded;
00343                         }
00344                 }
00345         }
00346 founded:
00347         <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a3">kfree</a>(Buf);
00348         <span class="keywordflow">if</span> (!found) <span class="keywordflow">return</span>(-1);
00349         <span class="keywordflow">return</span>(count*<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>);
00350 };
00351 
<a name="l00352"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a18">00352</a> <span class="keywordtype">void</span> <a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a13">ls</a>()
00353 {
00354         <span class="keywordtype">int</span> counter=0;
00355         <span class="keywordtype">int</span> h, <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>, scroll;
00356         <a class="code" href="http://minirighi.sourceforge.net/html/structSectorDir.html">SectorDir_t</a> *Buf;
00357 
00358         counter = <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a6">how_many_cluster</a>(<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>);
00359         Buf = <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a1">kmalloc</a>(<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>*counter);
00360         <a class="code" href="http://minirighi.sourceforge.net/html/group__KLowLevelMemoryManager.html#a7">memset</a>(Buf, 0, <a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>*counter);
00361 
00362         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a15">read_file</a>((<a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector_t</a> *)Buf, <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>, counter);
00363 
00364         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"\nList of files into the directory:\n\r\n\r"</span>);
00365         <span class="keywordflow">for</span>(h=0, scroll=0; h&lt;counter; h++)
00366         {
00367                 <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;(bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m2">BytesPerSector</a>/<span class="keyword">sizeof</span>(FileEntry_t)); <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00368                 {
00369                         <span class="keywordflow">if</span> (scroll==20)
00370                         {
00371                                 <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"\n\rPress a key to continue...\n\r"</span>);
00372                                 scroll=0;
00373                                 <span class="keywordflow">if</span> (<a class="code" href="http://minirighi.sourceforge.net/html/group__KeyboardDriver.html#a13">kgetchar</a>() == <a class="code" href="http://minirighi.sourceforge.net/html/keyboard_8h.html#a7">CTRL_C</a>)
00374                                 {
00375                                         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"\n\r"</span>);
00376                                         <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a3">kfree</a>(Buf);
00377                                         <span class="keywordflow">return</span>;
00378                                 }
00379                         }
00380                         <span class="keywordflow">if</span> ( <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a12">show_file_entry</a>(&amp;(Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>])) )
00381                                 scroll++;
00382                 }
00383         }
00384         <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a3">kfree</a>(Buf);
00385         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"\n\r"</span>);
00386 }
00387 
<a name="l00388"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a19">00388</a> <span class="keywordtype">bool</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a19">cat</a>(<span class="keywordtype">char</span> *stringa)
00389 {
00390         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> Nome[9], Ext[4];
00391         <a class="code" href="http://minirighi.sourceforge.net/html/structSectorDir.html">SectorDir_t</a> *Buf, *Buf2;
00392         <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> <a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector</a>;
00393         <span class="keywordtype">int</span> counter;
00394         <span class="keywordtype">int</span> h, <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>;
00395         <span class="keywordtype">bool</span> a=<a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a1">FALSE</a>;
00396 
00397         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a13">name_ext</a>(stringa, Nome, Ext);
00398 
00399         counter = <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a6">how_many_cluster</a>(<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>);
00400         Buf = <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a1">kmalloc</a>(<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>*counter);
00401         <a class="code" href="http://minirighi.sourceforge.net/html/group__KLowLevelMemoryManager.html#a7">memset</a>(Buf, 0, <a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>*counter);
00402         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a15">read_file</a>((<a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector_t</a> *)Buf, <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>, counter);
00403 
00404         <span class="keywordflow">for</span>(h=0; h&lt;counter; h++)
00405         {
00406                 <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>/<span class="keyword">sizeof</span>(FileEntry_t); <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00407                 {
00408                         a = <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a14">compare_name_ext</a>(Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Name, Nome, Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Extension, Ext);
00409                         <span class="keywordflow">if</span> (a)
00410                         {
00411                                 <span class="comment">// The file is empty //</span>
00412                                 <span class="keywordflow">if</span> ( !(Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].StartCluster) ) <span class="keywordflow">goto</span> founded;
00413 
00414                                 <span class="comment">// Print the file to the standard output //</span>
00415                                 <a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector</a> = Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].StartCluster;
00416                                 Buf2 = <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a1">kmalloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector_t</a>));
00417                                 <a class="code" href="http://minirighi.sourceforge.net/html/group__KLowLevelMemoryManager.html#a7">memset</a>(Buf2, 0, <span class="keyword">sizeof</span>(<a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector_t</a>));
00418                                 <span class="keywordflow">for</span> (;;)
00419                                 {
00420                                         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a15">read_file</a>((<a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector_t</a> *)Buf2, <a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector</a>, 1);
00421                                         <span class="keywordflow">for</span> (<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00422                                         {
00423                                                 <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a13">kputchar</a>( ((<a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a0">byte</a> *)Buf2)[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>] );
00424                                         }
00425                                         <span class="keywordflow">if</span> (!(<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a5">next_sector</a>(&amp;<a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector</a>, <a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector</a>))) <span class="keywordflow">break</span>;
00426                                 }
00427                                 <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a3">kfree</a>(Buf2);
00428                                 <span class="keywordflow">goto</span> founded;
00429                         }
00430                 }
00431         }
00432 founded:
00433         <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a3">kfree</a>(Buf);
00434         <span class="keywordflow">if</span> (!a) <span class="keywordflow">return</span>(FALSE);
00435         <span class="keywordflow">return</span>(TRUE);
00436 }
00437 
<a name="l00438"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a20">00438</a> <span class="keywordtype">void</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a20">add_dir_path</a>(<span class="keywordtype">char</span> *new_path)
00439 {
00440         <a class="code" href="http://minirighi.sourceforge.net/html/group__LibCString.html#a6">strcat</a>(<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a4">path</a>, new_path);
00441         <a class="code" href="http://minirighi.sourceforge.net/html/group__LibCString.html#a6">strcat</a>(<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a4">path</a>, <span class="stringliteral">"/"</span>);
00442 }
00443 
<a name="l00444"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a21">00444</a> <span class="keywordtype">void</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a21">up_dir_path</a>(<span class="keywordtype">void</span>)
00445 {
00446         <span class="keywordtype">int</span> <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>, k;
00447         <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a4">path</a>[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>]!=<span class="charliteral">'\0'</span>; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++);
00448         <span class="keywordflow">for</span>(k=(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>-2); <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a4">path</a>[k]!=<span class="charliteral">'/'</span>; k--);
00449         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a4">path</a>[++k] = <span class="charliteral">'\0'</span>;
00450 }
00451 
<a name="l00452"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a22">00452</a> <span class="keywordtype">char</span> *<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a12">pwd</a>()
00453 {
00454 <span class="comment">// Return the current path //</span>
00455         <span class="keywordflow">return</span>(path);
00456 }
00457 
<a name="l00458"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a23">00458</a> <span class="keywordtype">bool</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a23">cd</a>(<span class="keywordtype">char</span> *new_path)
00459 {
00460         <span class="keywordtype">int</span> counter=0;
00461         <span class="keywordtype">int</span> l, h, <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>;
00462         <span class="keywordtype">bool</span> change=<a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a1">FALSE</a>;
00463         <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> a=0;
00464         <a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html">attrib_t</a> FileAttr;
00465         <span class="keywordtype">char</span> dir_name[8];
00466         <a class="code" href="http://minirighi.sourceforge.net/html/structSectorDir.html">SectorDir_t</a> *Buf;
00467 
00468         <span class="comment">// Goto the root //</span>
00469         <span class="keywordflow">if</span> (new_path[0]==<span class="charliteral">'/'</span>)
00470                 <span class="keywordflow">if</span> (new_path[1]==<span class="charliteral">'\0'</span>)
00471                 {
00472                         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a4">path</a>[0]=<span class="charliteral">'\0'</span>;
00473                         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>=0;
00474                         <span class="keywordflow">return</span>(TRUE);
00475                 }
00476 
00477 
00478         counter = <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a6">how_many_cluster</a>(<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>);
00479         Buf = <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a1">kmalloc</a>(<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>*counter);
00480         <a class="code" href="http://minirighi.sourceforge.net/html/group__KLowLevelMemoryManager.html#a7">memset</a>(Buf, 0, <a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>*counter);
00481         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a15">read_file</a>((<a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector_t</a> *)Buf, <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>, counter);
00482 
00483         <span class="keywordflow">for</span>(h=0; h&lt;counter; h++)
00484         {
00485                 <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>/<span class="keyword">sizeof</span>(FileEntry_t); <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00486                 {
00487                         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a9">read_attrib</a>(&amp;FileAttr, Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Attribute);
00488                         <span class="keywordflow">if</span> (FileAttr.<a class="code" href="http://minirighi.sourceforge.net/html/structattrib.html#m4">Directory</a>)
00489                         {
00490                                 <span class="keywordflow">if</span> ((Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Name[0]!=0)&amp;&amp;(Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Name[0]!=0xE5))
00491                                 {
00492                                         <span class="keywordflow">if</span> (Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Name[0]==5) Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Name[0]=0xE5;
00493                                         l=0;
00494                                         <span class="keywordflow">do</span>
00495                                         {
00496                                                 dir_name[l]=Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Name[l];
00497                                         } <span class="keywordflow">while</span>(dir_name[l++]!=<span class="charliteral">' '</span>);
00498 
00499                                         dir_name[--l]=<span class="charliteral">'\0'</span>;
00500 
00501                                         <span class="keywordflow">if</span> (<a class="code" href="http://minirighi.sourceforge.net/html/group__LibCString.html#a0">strcmp</a>(new_path, dir_name)==0)
00502                                         {
00503                                                 a = Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].StartCluster;
00504                                                 change=<a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a0">TRUE</a>;
00505                                                 <span class="keywordflow">goto</span> founded;
00506                                         }
00507                                         <span class="keywordflow">if</span> (Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Name[0]==0xE5) Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Name[0]=0x05;
00508                                 }
00509                         }
00510                 }
00511         }
00512 founded:
00513         <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a3">kfree</a>(Buf);
00514         <span class="keywordflow">if</span> (change)
00515         {
00516                 <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a> = a;
00517                 <span class="keywordflow">if</span> (!a)
00518                         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a4">path</a>[0]=<span class="charliteral">'\0'</span>;
00519                 <span class="keywordflow">else</span>
00520                 {
00521                         <span class="keywordflow">if</span>(new_path[0] != <span class="charliteral">'.'</span>) <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a20">add_dir_path</a>(new_path);
00522                         <span class="keywordflow">else</span>
00523                         {
00524                                 <span class="keywordflow">if</span> (new_path[1] == <span class="charliteral">'.'</span>) <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a21">up_dir_path</a>();
00525                         }
00526                 }
00527                 <span class="keywordflow">return</span> <a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a0">TRUE</a>;
00528         }
00529         <span class="keywordflow">else</span>
00530                 <span class="keywordflow">return</span> <a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a1">FALSE</a>;
00531 }
00532 
00533 <span class="comment">// --- Write procedures ------------------------------------------------//</span>
<a name="l00534"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a24">00534</a> <span class="keywordtype">bool</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a24">fat12_write</a>()
00535 {
00536 <span class="comment">// Write the logical FAT to the disk                                    //</span>
00537         <span class="keywordtype">int</span> <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>, j;
00538 
00539         <span class="comment">// Converts the FAT from the logical structure into the         //</span>
00540         <span class="comment">// physical structure                                           //</span>
00541         <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0, j=0; j&lt;3072; j+=2)
00542         {
00543                 fat.<a class="code" href="http://minirighi.sourceforge.net/html/structFAT12.html#m0">data</a>[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++] = (byte)lfat.<a class="code" href="http://minirighi.sourceforge.net/html/structlogical__FAT12.html#m0">data</a>[j];
00544                 fat.<a class="code" href="http://minirighi.sourceforge.net/html/structFAT12.html#m0">data</a>[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++] = (byte)((lfat.<a class="code" href="http://minirighi.sourceforge.net/html/structlogical__FAT12.html#m0">data</a>[j]&gt;&gt;8)&amp;(0x0F))|((lfat.<a class="code" href="http://minirighi.sourceforge.net/html/structlogical__FAT12.html#m0">data</a>[j+1]&lt;&lt;4)&amp;(0xF0));
00545                 fat.<a class="code" href="http://minirighi.sourceforge.net/html/structFAT12.html#m0">data</a>[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++] = (byte)(lfat.<a class="code" href="http://minirighi.sourceforge.net/html/structlogical__FAT12.html#m0">data</a>[j+1]&gt;&gt;4);
00546         }
00547 
00548         <span class="comment">// Copy the FAT to the disk                                     //</span>
00549         <span class="keywordflow">for</span>(j=0; j&lt;bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m5">Fats</a>; j++)
00550         {
00551                 <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;3; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00552                         <span class="keywordflow">if</span> ( <a class="code" href="http://minirighi.sourceforge.net/html/floppy_8c.html#a22">fdc_write</a>(1, (<a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a0">byte</a> *)&amp;fat, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m9">SectorsPerFat</a>) )
00553                                 <span class="keywordflow">break</span>;
00554                 <span class="keywordflow">if</span> (<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a> == 3)
00555                         <span class="keywordflow">return</span>(FALSE);
00556         }
00557 
00558         <span class="comment">// Write successful!                                            //</span>
00559         <span class="keywordflow">return</span>(TRUE);
00560 }
00561 
<a name="l00562"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a25">00562</a> <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a25">find_sector</a>(<span class="keywordtype">int</span> n, <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> actual)
00563 {
00564 <span class="comment">// Find the sector n from actual                                        //</span>
00565         <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> c, temp;
00566 
00567         temp = actual;
00568         <span class="keywordflow">for</span>(c=0; c&lt;n; c++) <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a5">next_sector</a>(&amp;temp, temp);
00569         <span class="keywordflow">return</span>(temp);
00570 }
00571 
<a name="l00572"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a26">00572</a> <span class="keywordtype">void</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a26">write_sector_dir</a>(<a class="code" href="http://minirighi.sourceforge.net/html/structSectorDir.html">SectorDir_t</a> *<a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector</a>, <span class="keywordtype">int</span> num)
00573 {
00574         <span class="keywordtype">int</span> <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>, j;
00575         <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> dir_start = bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m5">Fats</a>*bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m9">SectorsPerFat</a>+1;
00576         <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> data_start = dir_start + bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m6">RootDirectoryEntries</a>*32/bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m2">BytesPerSector</a>-2;
00577 
00578         <span class="keywordflow">if</span>( !<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a> )
00579         {
00580                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)
00581                         <span class="keywordflow">if</span> ( <a class="code" href="http://minirighi.sourceforge.net/html/floppy_8c.html#a22">fdc_write</a>(dir_start+num, (<a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a0">byte</a> *)sector, 1) )
00582                                 <span class="keywordflow">break</span>;
00583         }
00584         <span class="keywordflow">else</span>
00585         {
00586                 <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a> = <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a25">find_sector</a>(num, <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>);
00587                 <span class="keywordflow">for</span>(j=0; j&lt;3; j++)
00588                         <span class="keywordflow">if</span> ( <a class="code" href="http://minirighi.sourceforge.net/html/floppy_8c.html#a22">fdc_write</a>(data_start+<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>, (<a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a0">byte</a> *)sector, 1) )
00589                                 <span class="keywordflow">break</span>;
00590         }
00591 }
00592 
<a name="l00593"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a27">00593</a> <span class="keywordtype">void</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a27">delete_file</a>(<a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> cluster)
00594 {
00595 <span class="comment">// Delete the file from the FAT structure                               //</span>
00596         <a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a1">word</a> next;
00597 
00598         <span class="keywordflow">while</span> ( <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a5">next_sector</a>(&amp;next, cluster) )
00599         {
00600                 lfat.<a class="code" href="http://minirighi.sourceforge.net/html/structlogical__FAT12.html#m0">data</a>[cluster] = 0;
00601                 cluster = next;
00602         }
00603         lfat.<a class="code" href="http://minirighi.sourceforge.net/html/structlogical__FAT12.html#m0">data</a>[cluster] = 0;
00604 }
00605 
<a name="l00606"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a28">00606</a> <span class="keywordtype">bool</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a28">rm</a>(<span class="keywordtype">char</span> *filename)
00607 {
00608 <span class="comment">// Remove a file from the disk                                          //</span>
00609         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="http://minirighi.sourceforge.net/html/ext2_8c.html#a28">name</a>[9], ext[4];
00610         <a class="code" href="http://minirighi.sourceforge.net/html/structSectorDir.html">SectorDir_t</a> *Buf;
00611         <span class="keywordtype">int</span> counter, h, <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>;
00612         <span class="keywordtype">bool</span> a=<a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a1">FALSE</a>;
00613 
00614         <span class="keywordflow">if</span> ( (<a class="code" href="http://minirighi.sourceforge.net/html/group__LibCString.html#a0">strcmp</a>(filename, <span class="stringliteral">"."</span>)==0) || (<a class="code" href="http://minirighi.sourceforge.net/html/group__LibCString.html#a0">strcmp</a>(filename, <span class="stringliteral">".."</span>)==0) )
00615                 <span class="keywordflow">return</span>(FALSE);
00616 
00617         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a13">name_ext</a>(filename, <a class="code" href="http://minirighi.sourceforge.net/html/ext2_8c.html#a28">name</a>, ext);
00618 
00619         counter = <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a6">how_many_cluster</a>(<a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>);
00620         Buf = <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a1">kmalloc</a>(<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>*counter);
00621         <a class="code" href="http://minirighi.sourceforge.net/html/group__KLowLevelMemoryManager.html#a7">memset</a>(Buf, 0, <a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>*counter);
00622         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a15">read_file</a>((<a class="code" href="http://minirighi.sourceforge.net/html/structsector.html">sector_t</a> *)Buf, <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a3">directory</a>, counter);
00623 
00624         <span class="keywordflow">for</span>(h=0; h&lt;counter; h++)
00625         {
00626                 <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>/<span class="keyword">sizeof</span>(FileEntry_t); <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00627                 {
00628                         a = <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a14">compare_name_ext</a>(Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Name, <a class="code" href="http://minirighi.sourceforge.net/html/ext2_8c.html#a28">name</a>, Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Extension, ext);
00629                         <span class="keywordflow">if</span> (a)
00630                         {
00631                                 <span class="comment">// Delete the file //</span>
00632                                 Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].Name[0] = 0xE5;
00633                                 <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a26">write_sector_dir</a>(&amp;Buf[h], h);
00634                                 <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a27">delete_file</a>(Buf[h].Entry[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>].StartCluster);
00635                                 <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a24">fat12_write</a>();
00636                                 <span class="keywordflow">goto</span> founded;
00637                 }
00638                 }
00639         }
00640 founded:
00641         <a class="code" href="http://minirighi.sourceforge.net/html/kmalloc_8c.html#a3">kfree</a>(Buf);
00642         <span class="keywordflow">if</span> (!a) <span class="keywordflow">return</span>(FALSE);
00643         <span class="keywordflow">return</span>(TRUE);
00644 }
00645 
00646 <span class="comment">// --- Init procedures -------------------------------------------------//</span>
<a name="l00647"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a29">00647</a> <span class="keywordtype">bool</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a29">init_FAT</a>()
00648 {
00649 <span class="comment">// Initialize the file system //</span>
00650         <span class="keywordtype">int</span> <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>;
00651 
00652         <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;3; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00653                 <span class="keywordflow">if</span> (<a class="code" href="http://minirighi.sourceforge.net/html/floppy_8c.html#a21">fdc_read</a>(<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a18">FAT_BOOT_SECTOR</a>, (<a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a0">byte</a> *)&amp;bootsector, 1))
00654                         <span class="keywordflow">break</span>;
00655         <span class="keywordflow">if</span> (<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a> != 3)
00656                 <span class="keywordflow">return</span>(TRUE);
00657         <span class="keywordflow">else</span>
00658                 <span class="keywordflow">return</span>(FALSE);
00659 }
00660 
<a name="l00661"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a30">00661</a> <span class="keywordtype">bool</span> <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a30">check_FAT</a>(<span class="keywordtype">void</span>)
00662 {
00663         <span class="keywordflow">if</span> ( (bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m2">BytesPerSector</a>!=<a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a19">FAT_SECTOR_SIZE</a>) || (bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m3">SectorsPerCluster</a>!=1) ||
00664         (bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m5">Fats</a>!=2) || (bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m6">RootDirectoryEntries</a>!=224) ||
00665         (bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m7">LogicalSectors</a>!=2880) || (bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m8">MediumDescriptorByte</a>!=0xF0) )
00666            {
00667                    <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"\n\rNot a valid FAT12 filesystem on the disk.\n\r"</span>);
00668                    <span class="keywordflow">return</span> <a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a1">FALSE</a>;
00669            }
00670         <span class="keywordflow">return</span> <a class="code" href="http://minirighi.sourceforge.net/html/const_8h.html#a0">TRUE</a>;
00671 }
00672 
<a name="l00673"></a><a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a31">00673</a> <span class="keywordtype">bool</span> <a class="code" href="http://minirighi.sourceforge.net/html/group__FSFAT12.html#a9">Read_FAT</a>()
00674 {
00675 <span class="comment">// Read the FAT from the floppy (mount) //</span>
00676         <span class="keywordtype">int</span> <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>, j;
00677 
00678         <span class="keywordflow">if</span> (!( <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a29">init_FAT</a>() ))
00679         {
00680                 <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"\n\rFloppy I/O error. Unable to read the block!!!\n\r"</span>);
00681                 <span class="keywordflow">return</span>(FALSE);
00682         }
00683 
00684         <span class="comment">// FAT initializazion OK! //</span>
00685         <span class="keywordflow">for</span> (<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;3; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>++)
00686                 <span class="keywordflow">if</span> (<a class="code" href="http://minirighi.sourceforge.net/html/floppy_8c.html#a21">fdc_read</a>(1, (<a class="code" href="http://minirighi.sourceforge.net/html/types_8h.html#a0">byte</a> *)&amp;fat, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m9">SectorsPerFat</a>))
00687                         <span class="keywordflow">break</span>;
00688         <span class="keywordflow">if</span> (<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a> == 3)
00689         {
00690                 <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"\n\rFloppy I/O error. Unable to read the block!!!\n\r"</span>);
00691                 <span class="keywordflow">return</span>(FALSE);
00692         }
00693 
00694         <span class="comment">// Converts the FAT into the logical structures (array of word) //</span>
00695         <span class="keywordflow">for</span>(<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>=0, j=0; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>&lt;4608; <a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>+=3)
00696         {
00697                 lfat.<a class="code" href="http://minirighi.sourceforge.net/html/structlogical__FAT12.html#m0">data</a>[j++] = (fat.<a class="code" href="http://minirighi.sourceforge.net/html/structFAT12.html#m0">data</a>[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>] + (fat.<a class="code" href="http://minirighi.sourceforge.net/html/structFAT12.html#m0">data</a>[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>+1] &lt;&lt; 8)) &amp; 0x0FFF;
00698                 lfat.<a class="code" href="http://minirighi.sourceforge.net/html/structlogical__FAT12.html#m0">data</a>[j++] = (fat.<a class="code" href="http://minirighi.sourceforge.net/html/structFAT12.html#m0">data</a>[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>+1] + (fat.<a class="code" href="http://minirighi.sourceforge.net/html/structFAT12.html#m0">data</a>[<a class="code" href="http://minirighi.sourceforge.net/html/group__KernelMain.html#a4">i</a>+2] &lt;&lt; 8)) &gt;&gt; 4;
00699         }
00700 
00701         <span class="comment">// Check if the FAT is correct //</span>
00702         <span class="keywordflow">if</span> (!( <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a30">check_FAT</a>() ))
00703         {
00704                 <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"\n\rNot a valid FAT12 filesystem!!!\n\r"</span>);
00705                 <span class="keywordflow">return</span>(FALSE);
00706         }
00707 
00708         <span class="comment">// Initialize the path //</span>
00709         <a class="code" href="http://minirighi.sourceforge.net/html/fat12_8c.html#a4">path</a>[0]=<span class="charliteral">'\0'</span>;
00710 
00711 <span class="preprocessor">        #ifdef FAT_DEBUG</span>
00712 <span class="preprocessor"></span>        <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"\n\rInitializing FileSystem...\n\r"</span>);
00713         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"\n\r"</span>);
00714         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"Jump:\t\t\t%02x %02x %02x\n\r"</span>, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m0">Jump</a>[0], bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m0">Jump</a>[1], bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m0">Jump</a>[2]);
00715         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"OS Name:\t\t\t%s\n\r"</span>, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m1">Name</a>);
00716         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"BytesPerSector:\t\t\t%u\n\r"</span>, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m2">BytesPerSector</a>);
00717         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"SectorsPerCluster:\t\t\t%u\n\r"</span>, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m3">SectorsPerCluster</a>);
00718         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"ReservedSectors:\t\t\t%u\n\r"</span>, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m4">ReservedSectors</a>);
00719         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"Fats:\t\t\t%u\n\r"</span>, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m5">Fats</a>);
00720         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"RootDirectoryEntries:\t\t\t%u\n\r"</span>, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m6">RootDirectoryEntries</a>);
00721         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"LogicalSectors:\t\t\t%u\n\r"</span>, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m7">LogicalSectors</a>);
00722         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"MediumDescriptorByte:\t\t\t%X\n\r"</span>, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m8">MediumDescriptorByte</a>);
00723         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"SectorsPerFat:\t\t\t%u\n\r"</span>, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m9">SectorsPerFat</a>);
00724         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"SectorsPerTrack:\t\t\t%u\n\r"</span>, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m10">SectorsPerTrack</a>);
00725         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"Heads:\t\t\t%u\n\r"</span>, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m11">Heads</a>);
00726         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"HiddenSectors:\t\t\t%u\n\r"</span>, bootsector.<a class="code" href="http://minirighi.sourceforge.net/html/structbootsect.html#m12">HiddenSectors</a>);
00727         <a class="code" href="http://minirighi.sourceforge.net/html/console_8c.html#a14">kprintf</a>(<span class="stringliteral">"\n\r"</span>);
00728 <span class="preprocessor">        #endif</span>
00729 <span class="preprocessor"></span>
00730         <span class="keywordflow">return</span>(TRUE);
00731 }
</pre></div><hr><address style="align: right;"><small>Generated on Fri Feb 20 15:32:15 2004 for Minirighi by
<a href="http://www.doxygen.org/index.html">
<img src="./fat12.c Source File_files/doxygen.png" alt="doxygen" align="middle" border="0" width="110" height="53"></a>1.2.18 </small></address>


</body></html>